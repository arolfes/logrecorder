version: 2

jobs:
  build:
    working_directory: ~/work
    docker:
      - image: caaqe/basic-build-environment
    steps:
      - checkout
      - run:
          name: Build
          command: mvn --batch-mode clean verify
  build-and-deploy-snapshot:
    working_directory: ~/work
    docker:
      - image: caaqe/basic-build-environment
    steps:
      - checkout
      - run:
          name: Build & Deploy Snapshot to OSSRH
          command: >-
            mvn --batch-mode clean deploy
            -DaltDeploymentRepository=ossrh::default::https://oss.sonatype.org/content/repositories/snapshots
            -Dossrh.username=$OSSRH_USERNAME
            -Dossrh.password=$OSSRH_PASSWORD
  build-and-deploy-release:
    working_directory: ~/work
    docker:
      - image: caaqe/basic-build-environment
    steps:
      - checkout
      - run:
          name: Set Project Version
          command: |
            VERSION=$(echo $CIRCLE_TAG | cut -d 'v' -f 2)
            mvn versions:set versions:commit -DnewVersion=$VERSION
      - run:
          name: Build & Deploy Release to OSSRH
          command: >-
            mvn --batch-mode clean deploy
            -Dgpg.passphrase=$GPG_PASSPHRASE
            -Dossrh.username=$OSSRH_USERNAME
            -Dossrh.password=$OSSRH_PASSWORD
            -P deploy-release

workflows:
  version: 2
  ci-build:
    jobs:
      - build:
          filters:
            tags:
              ignore: /.*/
            branches:
              ignore: master
  snapshot:
    jobs:
      - build-and-deploy-snapshot:
          filters:
            branches:
              only: master
  release:
    jobs:
      - build-and-deploy-release:
          filters:
            tags:
              only: /^v.*/
            branches:
              ignore: /.*/
